<%- include('../../layout/header') %>
<div class="card p-4">
  <div class="tab-pane preview-tab-pane active" role="tabpanel" aria-labelledby="tab-dom-da4be276-f13c-47d6-be82-655bc6452fd5" id="dom-da4be276-f13c-47d6-be82-655bc6452fd5">
    <div id="tableExample3" data-list='{"valueNames":["chucvu","mota","action"],"page":20,"pagination":true}'>
      <h4>Danh sách chức vụ</h4>
      <div class="m-b-30">
        <button type="button" class="btn btn-primary me-1 mb-1 mt-2" id="add-new-position">
          <i class="fas fa-plus-square"></i>&nbsp; Thêm mới
        </button>
      </div>
      <div class="row justify-content-end g-0">
        <div class="col-auto col-sm-5 mb-3">
          <form>
            <div class="input-group">
              <input class="form-control form-control-sm shadow-none search" type="search" placeholder="Search..." aria-label="search" />
              <div class="input-group-text bg-transparent">
                <span class="fa fa-search fs-10 text-600"></span>
              </div>
            </div>

          </form>
        </div>
      </div>
      <div class="table-responsive scrollbar">
        <table class="table table-bordered table-hover table-striped fs-10 mb-0">
          <thead class="bg-200">
            <tr>
              <th class="text-900 sort" data-sort="chucvu">Tên chức vụ</th>
              <th class="text-900 sort" data-sort="mota">Mô tả</th>
              <th class="text-900 sort" data-sort="action"></th>
            </tr>
          </thead>
          <tbody class="list">
            <% if (positions && positions.length > 0) { %>
              <% positions.forEach(function(position, key) { %>
              <tr data-id="<%= position.id %>" data-name="<%= position.name %>" data-description="<%= position.description %>">
                <td class="chucvu"><%= position.name %></td>
                <td class="mota" style="white-space: pre-line;"><%= position.description %></td>
                <td class="action">
                  <div class="table-data-feature d-flex">
                    <a class="item edit-btn btn-primary m-1" data-toggle="tooltip" data-placement="top" title="Edit">
                      <i class="fas fa-edit"></i>
                    </a>
                  </div>
                </td>
              </tr>
              <% }); %>
            <% } else { %>
              <tr>
                <td colspan="3" class="text-center py-4">
                  <div class="text-muted">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
                    <p class="mb-0">Chưa có dữ liệu</p>
                  </div>
                </td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
      <div class="d-flex justify-content-center mt-3">
        <button class="btn btn-sm btn-falcon-default me-1" type="button" title="Previous" data-list-pagination="prev">
          <span class="fas fa-chevron-left"></span>
        </button>
        <ul class="pagination mb-0"></ul>
        <button class="btn btn-sm btn-falcon-default ms-1" type="button" title="Next" data-list-pagination="next">
          <span class="fas fa-chevron-right"> </span>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function() {
    $('.delete-btn').click(function() {
      if (confirm('Bạn có chắc chắn muốn xóa phòng ban này không?')) {
        var row = $(this).closest('tr')
        var id = row.data('id')
        $.ajax({
          url: '/positions',
          data: {
            id: id,
          },
          type: 'DELETE',
          success: function(response) {
            row.remove()
          },
          error: function(xhr, status, error) {
            console.log(error)
          },
        })
      }
    })
    // Hiển thị modal thêm mới
    $('#add-new-position').click(function() {
      var form =
        '<div class="modal fade" id="newPositionModal" tabindex="-1" aria-labelledby="newPositionModalLabel" aria-hidden="true">' +
        '<div class="modal-dialog">' +
        '<div class="modal-content">' +
        '<div class="modal-header">' +
        '<h5 class="modal-title" id="newPositionModalLabel">Thêm mới chức vụ</h5>' +
        '<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>' +
        '</div>' +
        '<div class="modal-body">' +
        '<form action="/positions" id="new-position" method="post">' +
        '<div class="form-group">' +
        '<label for="name">Tên chức vụ:</label>' +
        '<input type="text" class="form-control" id="name" name="name">' +
        '</div>' +
        '<div class="form-group">' +
        '<label for="description">Mô tả:</label>' +
        '<textarea class="form-control" id="description" name="description"></textarea>' +
        '</div>' +
        '<div class="form-group">' +
        '<button class="btn btn-secondary mt-1" type="button" data-bs-dismiss="modal">Đóng</button>' +
        '<button type="submit" class="btn btn-primary me-1 mb-1 mt-2 m-2">Thêm mới</button>' +
        '</div>' +
        '</form>' +
        '</div>' +
        '</div>' +
        '</div>' +
        '</div>'
      // Thêm form vào body
      $('body').append(form)
      // Hiển thị modal
      $('#newPositionModal').modal('show')


      // validate add
      $('#name').on('input', function() {
        if ($(this).val().trim() === '') {
          $(this).css('border-color', 'red');
        } else {
          $(this).css('border-color', '#38b000');
        }
      });

      // Ngăn chặn submit form nếu các trường không hợp lệ
      // Ngăn chặn submit form nếu các trường không hợp lệ
      $('#new-position').on('submit', function(e) {
        var isValid = true;

        // Kiểm tra trường 'Tên phòng ban'
        if ($('#name').val().trim() === '') {
          $('#name').css('border-color', 'red');
          toastr.error("Tên chức vụ không được để trống!"); // Thông báo lỗi
          isValid = false;
        }

        if (!isValid) {
          e.preventDefault(); // Ngăn submit nếu không hợp lệ
        } else {
          e.preventDefault(); // Ngăn submit ngay lập tức
          toastr.success("Thêm mới chức vụ thành công!");
          // Chờ 0,7 giây rồi hiển thị thông báo và submit form
          setTimeout(function() {
            // Thông báo thành công
            $('#new-position')[0].submit(); // Submit form
          }, 1000); // 700ms = 0,7 giây
        }
      });

    })

    // Hiển thị modal chỉnh sửa khi click vào nút "Edit"
    $('.edit-btn').click(function() {
      // Lấy thông tin từ dòng được chọn
      var row = $(this).closest('tr')
      var id = row.data('id')
      var name = row.data('name')
      var description = row.data('description')

      // Tạo form chỉnh sửa động với dữ liệu từ dòng
      var editForm =
        '<div class="modal fade" id="editPositionModal" tabindex="-1" aria-labelledby="editPositionModalLabel" aria-hidden="true">' +
        '<div class="modal-dialog">' +
        '<div class="modal-content">' +
        '<div class="modal-header">' +
        '<h5 class="modal-title" id="editPositionModalLabel">Chỉnh sửa chức vụ</h5>' +
        '<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>' +
        '</div>' +
        '<div class="modal-body">' +
        '<form action="/positions?_method=PATCH" method="POST" id="edit-position-form">' +
        '<input type="hidden" name="id" id="edit-id" value="' +
        id +
        '">' +
        '<div class="form-group">' +
        '<label for="edit-name">Tên chức vụ:</label>' +
        '<input type="text" class="form-control" id="edit-name" name="name" value="' +
        name +
        '" required>' +
        '</div>' +
        '<div class="form-group">' +
        '<label for="edit-description">Mô tả:</label>' +
        '<textarea class="form-control" id="edit-description" name="description">' +
        description +
        '</textarea>' +
        '</div>' +
        '<div class="form-group">' +
        '<button class="btn btn-secondary mt-1" type="button" data-bs-dismiss="modal">Đóng</button>' +
        '<button type="submit" class="btn btn-primary me-1 mb-1 mt-2 m-2">Lưu thay đổi</button>' +
        '</div>' +
        '</form>' +
        '</div>' +
        '</div>' +
        '</div>' +
        '</div>'

      // Thêm form chỉnh sửa vào body và hiển thị modal
      $('body').append(editForm)
      $('#editPositionModal').modal('show')


      // Validate edit
      $('#edit-name').on('input', function() {
        if ($(this).val().trim() === '') {
          $(this).css('border-color', 'red');
        } else {
          $(this).css('border-color', '#38b000');
        }
      });

      // Ngăn chặn submit form nếu các trường không hợp lệ
      $('#edit-position-form').on('submit', function(e) {
        var isValid = true;

        // Kiểm tra trường 'Tên phòng ban'
        if ($('#edit-name').val().trim() === '') {
          $('#edit-name').css('border-color', 'red');
          toastr.error("Tên chức vụ không được để trống!"); // Thông báo lỗi
          isValid = false;
        }

        if (!isValid) {
          e.preventDefault(); // Ngăn submit nếu không hợp lệ
        } else {
          e.preventDefault(); // Ngăn submit ngay lập tức

          // Thông báo thành công
          toastr.success("Sửa chức vụ thành công!");


          setTimeout(function() {
            $('#edit-position-form')[0].submit(); // Submit form sau 2 giây
          }, 1000);
        }
      });
    })
  })
</script>
<%- include('../../layout/footer') %>
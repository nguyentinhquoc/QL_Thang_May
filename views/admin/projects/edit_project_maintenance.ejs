<%- include('../../layout/header') %>

<form action="/project/<%= project.id %>?_method=Patch" method="POST" id="FormAdd">
  <div class="row m-t-15 m-b-15">
    <div class="col-lg-12">
      <div class="card">
        <div class="card-body text-secondary">
          <h2 class=" m-b-30">Sửa công trình</h2>
          <div id="staff-container" class="mt-3 mb-3"></div>
          <div class="d-flex justify-content-between">
            <div class="form-group col-7">
              <label for="full_name">Tên công trình <span
                  style="color: red;">*</span></label>
              <input type="text" id="full_name" name="full_name" class="form-control"
                required maxlength="255" value="<%= project.full_name %>">
            </div>
            <div class="form-group col-3">
              <label for="code_project">Mã công trình <span
                  style="color: red;">*</span></label>
              <input type="text" placeholder="Enter code" id="code_project"
                name="code_project" class="form-control" required maxlength="255"
                value="<%= project.code_project %>">
            </div>
          </div>
          <div class="form-group">
            <label for="number_phone">Số điện thoại <span
                style="color: red;">*</span></label>
            <input type="tel" id="number_phone" name="number_phone" class="form-control"
              required maxlength="15" value="<%= project.number_phone %>">
          </div>
          <div class="form-group">
            <label for="email">Địa chỉ email</label>
            <input type="email" id="email" name="email" class="form-control"
              maxlength="255" value="<%= project.email %>">
          </div>

              <div class="form-group col-12">
            <label for="city">Tỉnh/Thành phố:</label>
            <select required id="city" name="city" class="form-control">
              <option value="" selected disabled>Chọn tỉnh thành</option>
            </select>
          </div>

          <div class="form-group col-12">
            <label for="district">Quận/Huyện:</label>
            <select id="district" name="district" class="form-control">
              <option value="" selected disabled>Chọn quận huyện</option>
            </select>
          </div>

          <div class="form-group col-12">
            <label for="ward">Phường/Xã:</label>
            <select id="ward" name="ward" class="form-control">
              <option value="" selected disabled>Chọn phường xã</option>
            </select>
          </div>


          <div class="form-group">
            <label for="address">Địa chỉ lắp đặt <span
                style="color: red;">*</span></label>
            <textarea id="address" name="address"
              class="form-control"></textarea>
          </div>
          <div class="d-flex" style="justify-content: space-between;">
            <div class="form-group">
              <label for="price">Giá trị hợp đồng: <span
                  style="color: red;">*</span></label>
              <input type="text"
                value="<%= new Intl.NumberFormat('vi-VN').format(project.price) %>"
                placeholder="Nhập giá trị hợp đồng" id="price" class="form-control"
                onkeyup="formatCurrency(this)">
              <input type="hidden" name="price" id="price_hidden"
                value="<%= project.price %>">
              <script>
                function formatCurrency(input) {
                  // Remove non-numeric characters
                  let value = input.value.replace(/[^\d]/g, '');

                  // Store the raw value in hidden field
                  document.getElementById('price_hidden').value = value;

                  // Format with thousands separators
                  if (value) {
                    input.value = new Intl.NumberFormat('vi-VN').format(value);
                  }
                }
              </script>
            </div>
            <div class="form-group">
              <label for="tax">Thuế:</label>
              <select id="tax" name="tax" class="form-control">
                <option value="Có" <%=project.tax == 'Có' ? 'selected' : '' %>>Có</option>
                <option value="Không" <%=project.tax == 'Không' ? 'selected' : ''
                  %>>Không</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="description">Ghi chú</label>
            <textarea id="description" name="description" class="form-control"
              maxlength="225"><%= project.description %></textarea>
            <p>
              <table class="table">
                <thead>
                  <tr>
                    <th scope="col">Thông tin</th>
                    <th scope="col">Giá trị</th>
                  </tr>
                </thead>
                   <%
                    let infor_product;
                    if (project.infor_product) {
                        infor_product = JSON.parse(project.infor_product);
                    }
                    %>
                <tbody>
                  <tr>
                    <td><label for="dongCo">Động cơ</label></td>
                    <td><input type="text" id="dongCo" name="dongCo"
                        value="<%= infor_product.dongCo %>"
                        class="form-control"></td>
                  </tr>
                  <tr>
                    <td><label for="tuDien">Tủ điện</label></td>
                    <td><input type="text" id="tuDien" name="tuDien"
                        value="<%= infor_product.tuDien %>"
                        class="form-control"></td>
                  </tr>
                  <tr>
                    <td><label for="capTai">Cáp Tải</label></td>
                    <td><input type="text" id="capTai" name="capTai"
                        value="<%= infor_product.capTai %>"
                        class="form-control"></td>
                  </tr>
                  <tr>
                    <td><label for="congSuat">Công suất</label></td>
                    <td><input type="text" id="congSuat" name="congSuat"
                        value="<%= infor_product.congSuat %>"
                        class="form-control"></td>
                  </tr>
                  <tr>
                    <td><label for="hoThang">Hố thang</label></td>
                    <td><input type="text" id="hoThang" name="hoThang"
                        value="<%= infor_product.hoThang %>"
                        class="form-control"></td>
                  </tr>
                  <tr>
                    <td><label for="cabin">Cabin</label></td>
                    <td><input type="text" id="cabin" name="cabin"
                        value="<%= infor_product.cabin %>"
                        class="form-control"></td>
                  </tr>
                  <tr>
                    <td><label for="cua">Cửa</label></td>
                    <td><input type="text" id="cua" name="cua"
                        value="<%= infor_product.cua %>"
                        class="form-control"></td>
                  </tr>
                  <tr>
                    <td><label for="pit">Pít</label></td>
                    <td><input type="text" id="pit" name="pit"
                        value="<%= infor_product.pit %>"
                        class="form-control"></td>
                  </tr>
                  <tr>
                    <td><label for="oh">OH</label></td>
                    <td><input type="text" id="oh" name="oh"
                        value="<%= infor_product.oh %>" class="form-control"></td>
                  </tr>
                  <tr>
                    <td><label for="phongMay">Phòng máy</label></td>
                    <td><input type="text" id="phongMay" name="phongMay"
                        value="<%= infor_product.phongMay %>"
                        class="form-control"></td>
                  </tr>
                </tbody>
              </table>
              <button class="btn btn-primary btn-lg btn-block w-100"
                onclick="SubmitForm(event)">Sửa công trình</button>
            </div>
          </section>
        </div>
      </div>
    </div>
  </form>
  <script>
  function toggleStaffContainer() {
    const staffContainer = document.getElementById('staff-container');
    if (staffContainer.style.display === 'none') {
      staffContainer.style.display = 'block';
    } else {
      staffContainer.style.display = 'none';
    }
  }

  function selectStaff(element, name, id) {
    const searchBox = element.closest('.d-flex').querySelector('.staff-search');
    const hiddenInput = element.closest('.d-flex').querySelector('.staff-main-id');
    const list = element.closest('.d-flex').querySelector('.item-list');
    searchBox.value = name;
    hiddenInput.value = id;
    list.style.display = "none";
  }

  function filterList2(element) {
    const container = element.closest('.d-flex');
    const input = container.querySelector('.staff-search').value.toLowerCase();
    const selectedDepartment = container.querySelector('.department-select').value;
    const items = container.querySelectorAll('.item-list li');
    const list = container.querySelector('.item-list');
    if (input || selectedDepartment) {
      list.style.display = "block";
    } else {
      list.style.display = "none";
    }
    items.forEach(item => {
      const itemText = item.textContent.toLowerCase();
      const departmentId = item.getAttribute('idDepartment');
      if (
        (itemText.includes(input) || !input) &&
        (departmentId === selectedDepartment || !selectedDepartment)
      ) {
        item.style.display = "";
      } else {
        item.style.display = "none";
      }
    });
  }
  /// Thêm nhân viên
  function addStaff() {
    const container = document.getElementById('staff-container');
    const newStaff = document.createElement('div');
    newStaff.classList.add('d-flex', 'staff-select');
    newStaff.innerHTML = `
    <select class="form-select form-select-sm department-select" style="width: fit-content;"
      aria-label=".form-select-sm example" onchange="filterList2(this)">
      <% departments.forEach(function(department, key) { %>
      <option value="<%=department.id %>" >
        <%=department.name %>
      </option>
      <% }) %>
    </select>
    <div class="w-100">
      <input type="text" class="form-control staff-search" placeholder="Nhập tên nhân viên"
        aria-label="Recipient's username" aria-describedby="button-addon2" oninput="filterList2(this)">
      <ul style="position: absolute;" class="card item-list">
        <% staffs.forEach(function(staff) { %>
        <li class="btn w-100 infor-staff" idDepartment="<%=staff.department.id%>"
          onclick="selectStaff(this, '<%=staff.full_name%>', '<%=staff.id%>')">
          <%=staff.full_name%> - <%=staff.number_phone%>
        </li>
        <% }) %>
      </ul>
    </div>
    <input type="hidden" class="staff-main-id" name="staffMain[]">
    <button class="btn btn-danger" onclick="removeStaff(this)">Xóa</button>
  `;
    container.appendChild(newStaff);
  }

  function removeStaff(button) {
    const container = button.closest('.staff-select');
    container.remove();
  }
  function removeMainStaff(projectStaff, element) {
    if (confirm("Bạn có chắc chắn muốn xóa nhân viên này?")) {
      $.ajax({
        url: `/project-staff/${projectStaff}`,
        type: 'DELETE',
        data: {},
        success: function(response) {
          $(element).closest('.col-auto').remove();
        },
        error: function(xhr, status, error) {
          console.log(error);
        }
      });
    }
  }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
<script>
  const defaultAddress = '<%= project.address %>'
    const host = "https://provinces.open-api.vn/api/";
    // === ✅ Chuỗi địa chỉ mặc định ===
    // === ✅ Tách dữ liệu mặc định từ chuỗi ===
    const [defaultCityName, defaultDistrictName, defaultWardName, detailAdress] = defaultAddress.split(',').map(s => s.trim());
    document.querySelector('#address').value = detailAdress ?? ''
    // === ✅ Hàm render có so sánh theo tên (name) ===
    const renderData = (array, selectId, defaultName = null) => {
      let row = '<option disabled value="">Chọn</option>';
      array.forEach(element => {
        const selected = (defaultName && element.name.toLowerCase().includes(defaultName.toLowerCase())) ? 'selected' : '';
        row += `<option data-id="${element.code}" value="${element.name}" ${selected}>${element.name}</option>`;
      });
      $("#" + selectId).html(row);
    };
    // === ✅ Gọi API tỉnh, quận, phường ===
    const callAPI = () => {
      return axios.get(`${host}?depth=1`).then(res => {
        renderData(res.data, "city", defaultCityName);
        const selectedCity = res.data.find(c => c.name.toLowerCase().includes(defaultCityName.toLowerCase()));
        if (selectedCity) {
          return axios.get(`${host}p/${selectedCity.code}?depth=2`).then(resDistrict => {
            renderData(resDistrict.data.districts, "district", defaultDistrictName);

            const selectedDistrict = resDistrict.data.districts.find(d => d.name.toLowerCase().includes(defaultDistrictName.toLowerCase()));
            if (selectedDistrict) {
              return axios.get(`${host}d/${selectedDistrict.code}?depth=2`).then(resWard => {
                renderData(resWard.data.wards, "ward", defaultWardName);
                printResult(); // Hiển thị kết quả
              });
            }
          });
        }
      });
    };

    // === ✅ In kết quả địa chỉ đã chọn ===
    const printResult = () => {
      const cityText = $("#city option:selected").text();
      const districtText = $("#district option:selected").text();
      const wardText = $("#ward option:selected").text();
      const cityCode = $("#city").find(':selected').data('id');
      const districtCode = $("#district").find(':selected').data('id');
      const wardCode = $("#ward").find(':selected').data('id');
      if (cityCode && districtCode && wardCode) {
        $("#result").text(`${cityText} | ${districtText} | ${wardText}`);
      }
    };

    // === ✅ Sự kiện thay đổi ===
    $("#city").on("change", function() {
      const cityId = $(this).find(':selected').data('id');
      if (cityId) {
        axios.get(`${host}p/${cityId}?depth=2`).then(res => {
          renderData(res.data.districts, "district");
          $("#ward").html('<option disabled value="">Chọn</option>');
        });
      }
      printResult();
    });

    $("#district").on("change", function() {
      const districtId = $(this).find(':selected').data('id');
      if (districtId) {
        axios.get(`${host}d/${districtId}?depth=2`).then(res => {
          renderData(res.data.wards, "ward");
        });
      }
      printResult();
    });

    $("#ward").on("change", function() {
      printResult();
    });

    // === ✅ Gọi khởi tạo ===
    callAPI();
</script>
  <%- include('../../layout/footer') %>